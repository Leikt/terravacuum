# Terravacuum

---

Terravacuum is a plugin based python package that help create Terraform code from existing infrastructure.

## Installation

Upgrade your pip module and download the terravacuum package.

`pip install --upgrade pip terravaccum`

Import terravacuum inside your project:
`import terravacuum`

Or use only the parts you are interested in:

`from terravacuum import PluginLoader, register_plugin_sockets, register_core_plugins`

## Quick start

Here is a basic usage of terravacuum :

```python
from terravacuum import load_file, create_context, create_component, get_renderer
from terravacuum.core_plugins import initialize

initialize()

template = load_file('path/to/template.yml')
variables = load_file('path/to/variables.yml')
data = load_file('path/to/data.json')

ctx_component = create_context(data=data, variables=variables)
ctx_rendering = create_context()

component = create_component(ctx_component, template)

renderer = get_renderer(component.renderer)
renderer(ctx_rendering, component)
```

### Detail

* Load the different needed elements

```python
from terravacuum import load_file, create_context, create_component, get_renderer
```

* Register the plugin sockets and the core plugins

```python
initialize()
```

This action can also be done with:

```python
from terravacuum import register_plugin_sockets
from terravacuum.core_plugins import register_core_plugins

register_plugin_sockets()
register_core_plugins()
```

* Load the template, data and variables from a file. The template can be any file loadable by the system. In core
  component that include
  .yml and .json. If you add plugins, you can load from other formats.

```python
template = load_file('path/to/template.yml')
variables = load_file('path/to/variables.yml')
data = load_file('path/to/data.json')
```

* Create the component context

```python
ctx_component = create_context(data=data, variables=variables)
```

A component context requires the data variable. Otherwise, no data will be renderer and it can cause bugs.
> Note: anything can be added to a context. If a plugin requires a specific variable, it should be added here.

* Create rendering context

```python
ctx_rendering = create_context()
```

Create a context for the renderers. It should contains the initial variables the renderers need to do their work.

For exemple, the core renderers use the variable `indentation` to manage the indentation of the code.

* Create the root component

```python
component = create_component(ctx_component, template)
```

> Note: A template should always represent a single component. In the core plugin, 'project' assume this role.

* Render the root component

```python
renderer = get_renderer(component.renderer)
renderer(ctx_rendering, component)
```

First we get the renderer of the root component. Then we call the renderer with previously create context on the
component.

> Note: We are using core plugins and our root component is a 'project' so there is no pertinent output. 'project'
> component render everything in files.

### Tips

* change_working_directory
  If you want to run the component creation and the rendering in different locations, use the context
  manager `change_working_directory`:

```python
from terravacuum import change_working_directory

with change_working_directory('path/to/other/location'):
    renderer(ctx_rendering, component)
```

## Template

Terravacuum uses template to create terraform code. A template is a file that describe how the terraform code should be
organized.

Here is a simple template example :

```yaml
section:
  header: instance
  children:
    - property: name=instance_id value=$.InstanceId
    - property: name=name value=$.InstanceName
```

If we give terravacuum the data `{"InstanceId":"i-12932oezirjez", "InstanceName":"my_instance"`, the result will be:

```
instance {
  instance_id = i-12932oezirjez
  name = my_instance
}
```

See the documentation on core plugins to learn how to write your templates.

### Data and variables placeholder

When Terravacuum renders the template, it guesses the that any string is a variables or a data reference.
In the core plugins, "$." and "~." indicate a data or a variable. These ref's syntax is JsonPath.

Train yourself on this powerful tool with the website : https://jsonpath.com/

Data and variables are two separate things:
* data represents your infrastructure data. It is generally generated by a DataCollector.
* variables are manually set in a separate file and should be edited by the user.

## Plugin architecture

Terravacuum has a plugin based architecture. It means that a lot of things can be extended:

* Data collection
* File loading
* Components
* Component factories
* Renderers
* Expression parsing

To do so, just download the plugin package and add load it with `PluginLoader.load_plugin('package')`

### Organize plugins

You can load plugin in a hard coded way. The best practice is to list the plugins into a file and load them using:

`PluginLoader.load_plugins_from_file('your_plugin_file')`